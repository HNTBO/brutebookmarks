/**
 * One-time script to generate src/data/emoji-data.ts from unicode-emoji-json + emojilib.
 * Run with: node scripts/generate-emoji-data.mjs
 *
 * Cross-references both packages with Twemoji 14.0.2 SVGs to ensure every
 * entry actually has a renderable icon. Output is a static TypeScript file
 * that gets committed to the repo — no runtime fetching needed.
 */

import { createRequire } from 'module';
import { writeFileSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const require = createRequire(import.meta.url);
const unicodeData = require('unicode-emoji-json');
const emojilib = require('emojilib');

const __dirname = dirname(fileURLToPath(import.meta.url));
const TWEMOJI_BASE = 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/';

// Convert emoji character to Twemoji-style codepoint (lowercase hex, hyphen-separated)
function emojiToCodepoint(emoji) {
  return [...emoji]
    .map((c) => c.codePointAt(0).toString(16))
    .filter((cp) => cp !== 'fe0f') // Twemoji strips variation selectors from filenames
    .join('-');
}

// Verify the SVG exists on the CDN by checking known Twemoji 14.0.2 codepoint patterns.
// We skip component emojis (skin tones, hair styles) and keycap sequences.
function isLikelyTwemojiSupported(codepoint, entry) {
  // Skip skin tone variants (modifier codepoints 1f3fb-1f3ff)
  if (/1f3f[b-f]/.test(codepoint)) return false;
  // Skip component emojis
  if (entry.group === 'Component') return false;
  return true;
}

// Build keyword list: combine emojilib keywords + unicode name words
function buildKeywords(emoji, unicodeEntry) {
  const libKeywords = emojilib[emoji] || [];
  const nameWords = unicodeEntry.name
    .toLowerCase()
    .split(/[\s-]+/)
    .filter((w) => w.length > 1);

  // Merge, deduplicate, remove underscores from emojilib entries
  const all = new Set([
    ...libKeywords.map((kw) => kw.replace(/_/g, ' ').toLowerCase()),
    ...nameWords,
  ]);

  // Remove very short, noisy, or filler keywords
  const stopWords = new Set(['a', 'an', 'the', 'of', 'with', 'and', 'or', 'in', 'on', 'at', 'to', 'for', 'is', 'it']);
  return [...all].filter((kw) => kw.length > 1 && !kw.startsWith(':') && !stopWords.has(kw));
}

// Group names from unicode-emoji-json for section comments
const GROUP_ORDER = [
  'Smileys & Emotion',
  'People & Body',
  'Animals & Nature',
  'Food & Drink',
  'Travel & Places',
  'Activities',
  'Objects',
  'Symbols',
  'Flags',
];

// Build entries grouped by category
const grouped = new Map();
GROUP_ORDER.forEach((g) => grouped.set(g, []));

let skipped = 0;
let included = 0;

for (const [emoji, entry] of Object.entries(unicodeData)) {
  const codepoint = emojiToCodepoint(emoji);
  if (!isLikelyTwemojiSupported(codepoint, entry)) {
    skipped++;
    continue;
  }

  const keywords = buildKeywords(emoji, entry);
  if (keywords.length === 0) {
    skipped++;
    continue;
  }

  const group = entry.group || 'Other';
  if (!grouped.has(group)) grouped.set(group, []);

  grouped.get(group).push({ emoji, codepoint, keywords });
  included++;
}

// Generate TypeScript output
let output = `// Auto-generated by scripts/generate-emoji-data.mjs — do not edit by hand.\n`;
output += `// Source: unicode-emoji-json + emojilib, filtered to Twemoji 14.0.2 coverage.\n`;
output += `// ${included} entries across ${grouped.size} categories.\n\n`;
output += `export const EMOJI_DATA: { emoji: string; codepoint: string; keywords: string[] }[] = [\n`;

for (const [group, entries] of grouped) {
  if (entries.length === 0) continue;
  output += `\n  // ── ${group} (${'─'.repeat(Math.max(0, 50 - group.length))})\n`;
  for (const e of entries) {
    const kwList = e.keywords.map((kw) => `'${kw.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'`).join(', ');
    output += `  { emoji: '${e.emoji}', codepoint: '${e.codepoint}', keywords: [${kwList}] },\n`;
  }
}

output += `];\n`;

const outPath = resolve(__dirname, '..', 'src', 'data', 'emoji-data.ts');
writeFileSync(outPath, output, 'utf-8');

console.log(`Generated ${outPath}`);
console.log(`  Included: ${included} emojis`);
console.log(`  Skipped:  ${skipped} (components, skin tones, no keywords)`);
